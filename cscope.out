cscope 15 $HOME/CMPSC-447/hw3/trans -q 0000000292 0000021405
	@main.c

32 
	~<¡dio.h
>

33 
	~<uni¡d.h
>

34 
	~<¡dlib.h
>

35 
	~<fú.h
>

36 
	~<”ºo.h
>

37 
	~<sys/ty³s.h
>

38 
	~<sys/¡©.h
>

39 
	~<sys/sock‘.h
>

40 
	~<Ãtš‘/š.h
>

41 
	~<¬·/š‘.h
>

42 
	~<¡ršg.h
>

45 
	~"siis-ut.h
"

46 
	~"siis-ÃtwÜk.h
"

47 
	~"Œªsãr.h
"

51 
	#USAGE
 "USAGE: cl›Á <f’ame> <£rv” IP‡dd»ss> <commªd> <fe_ty³>\n"

	)

52 
	#SERVER_USAGE
 "USAGE: s”v” g’key/»cvfe\n"

	)

65 
	$maš
Ğ
¬gc
, **
¬gv
 )

68 #ifdeà
SERVER


70 
key
[
KEYSIZE
];

73 iàĞ
¬gc
 < 2 )

76 
	`”rÜMes§ge
( "missing or bad command†ine‡rguments\n" );

77 
	`´štf
Ğ
SERVER_USAGE
 );

78 
	`ex™
( -1 );

81 ià(
	`¡rcmp
(
¬gv
[1],"genkey") == 0) {

84 ià(
	`g’”©e_p£udÜªdom_by‹s
(
key
, 
KEYSIZE
) != 0) {

85 
	`ex™
(-1);

89 
	`§ve_key
("./’ckey", 
key
, 
KEYSIZE
);

94 ià(
	`¡rcmp
(
¬gv
[1],"recvfile") == 0) {

97 
	`£rv”_£cu»_Œªsãr
(
key
);

102 
	`”rÜMes§ge
( "the second‡rg must beƒither genkey or„ecvfile\n" );

103 
	`´štf
Ğ
SERVER_USAGE
 );

104 
	`ex™
( -1 );

109 
rm_cmd
 *
r
;

110 
”r
;

113 iàĞ
¬gc
 < 5 )

116 
	`”rÜMes§ge
( "missing or bad command†ine‡rguments\n" );

117 
	`´štf
Ğ
USAGE
 );

118 
	`ex™
( -1 );

123 
”r
 = 
	`make_»q_¡ruù
Ğ&
r
, 
¬gv
[1],‡rgv[3],‡rgv[4] );

124 ià(
”r
) {

125 
	`”rÜMes§ge
( "cannot…rocess„equest†ine into command\n" );

126 
	`´štf
Ğ
USAGE
 );

127 
	`ex™
( -1 );

131 
¡©
 
¡
;

132 
¡©us
 = 
	`¡©
Ğ
¬gv
[1], &
¡
 ),

133 
»adabË
 = ( ((
¡
.
¡_uid
 =ğ
	`g‘uid
()è&& (¡.
¡_mode
&
S_IRUSR
)) ||

134 (
¡
.
¡_mode
&
S_IROTH
) );

135 iàĞ(
¡©us
 =ğ-1è|| (!
»adabË
) )

138 
msg
[128];

139 
	`¥rštf
Ğ
msg
, "nÚ-exi¡ªˆÜ uÄ—bË f[%.64s]\n", 
¬gv
[1] );

140 
	`”rÜMes§ge
Ğ
msg
 );

141 
	`´štf
Ğ
USAGE
 );

142 
	`ex™
( -1 );

146 iàĞ
	`š‘_addr
(
¬gv
[2]è=ğ
INADDR_NONE
 )

149 
msg
[128];

150 
	`¥rštf
Ğ
msg
, "bad s”v” IP‡dd»s [%.64s]\n", 
¬gv
[2] );

151 
	`”rÜMes§ge
Ğ
msg
 );

152 
	`´štf
Ğ
USAGE
 );

153 
	`ex™
( -1 );

158 
	`´štf
Ğ"T¿nsã¸begšnšg, f[%s]\n", 
¬gv
[1] );

159  ( 
	`ş›Á_£cu»_Œªsãr
Ğ
r
, 
¬gv
[1],‡rgv[2]) );

162 
	}
}

	@siis-network.c

32 
	~<”ºo.h
>

33 
	~<¡ršg.h
>

34 
	~<¡dlib.h
>

35 
	~<¡dio.h
>

36 
	~<Ãtš‘/š.h
>

37 
	~<¬·/š‘.h
>

38 
	~<sys/ty³s.h
>

39 
	~<sys/sock‘.h
>

42 
	~"siis-ut.h
"

43 
	~"siis-ÃtwÜk.h
"

56 
	$cÚÃù_ş›Á
Ğ*
add»ss
 )

59 
sock
;

60 
sockaddr_š
 
š‘
;

63 
	`mem£t
Ğ&
š‘
, 0x0, (inet) );

64 
š‘
.
sš_çmy
 = 
AF_INET
;

65 
š‘
.
sš_pÜt
 = 
	`htÚs
Ğ
PROTOCOL_PORT
 );

66 
š‘
.
sš_addr
.
s_addr
 = 
	`š‘_addr
Ğ(*)
add»ss
 );

69 iàĞ(
sock
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0)) == -1 )

72 
	`”rÜMes§ge
( "failed„ead on data file.\n" );

73 
	`ex™
( -1 );

77 iàĞ
	`cÚÃù
(
sock
, (
sockaddr
 *)&
š‘
, (inet)) != 0 )

80 
msg
[128];

81 
	`¥rštf
Ğ
msg
, "failed client socket connection [%.64s]\n",

82 
	`¡»¼Ü
(
”ºo
) );

83 
	`”rÜMes§ge
Ğ
msg
 );

84 
	`ex™
( -1 );

88 
	`´štf
( "Client connectedo‡ddress [%s/%d], successful ...\n",

89 
add»ss
, 
PROTOCOL_PORT
 );

92 Ğ
sock
 );

93 
	}
}

104 
	$£rv”_cÚÃù
( )

107 
sock
;

108 
sockaddr_š
 
š‘
;

111 
	`mem£t
Ğ&
š‘
, 0x0, (inet) );

112 
š‘
.
sš_çmy
 = 
AF_INET
;

113 
š‘
.
sš_pÜt
 = 
	`htÚs
Ğ
PROTOCOL_PORT
 );

114 
š‘
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

117 iàĞ(
sock
 = 
	`sock‘
Ğ
AF_INET
, 
SOCK_STREAM
, 0)) == -1 )

120 
msg
[128];

121 
	`¥rštf
Ğ
msg
, "failed server socket create [%.64s]\n",

122 
	`¡»¼Ü
(
”ºo
) );

123 
	`”rÜMes§ge
Ğ
msg
 );

124 
	`ex™
( -1 );

128 
Ú
 = 1;

129 
	`£tsockİt
Ğ
sock
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
Ú
, (on));

132 iàĞ
	`bšd
(
sock
, (
sockaddr
 *)&
š‘
, (inet)) != 0 )

135 
msg
[128];

136 
	`¥rštf
Ğ
msg
, "failed server socket bind [%.64s]\n",

137 
	`¡»¼Ü
(
”ºo
) );

138 
	`”rÜMes§ge
Ğ
msg
 );

139 
	`ex™
( -1 );

143 iàĞ
	`li¡’
(
sock
, 5) != 0 )

146 
msg
[128];

147 
	`¥rštf
Ğ
msg
, "failed server socket†isten [%.64s]\n",

148 
	`¡»¼Ü
(
”ºo
) );

149 
	`”rÜMes§ge
Ğ
msg
 );

150 
	`ex™
( -1 );

154 
	`´štf
( "Server bindingo…ort [%d], successful ...\n",

155 
PROTOCOL_PORT
 );

158 Ğ
sock
 );

159 
	}
}

170 
	$£rv”_acû±
Ğ
sock
 )

172 
sockaddr_š
 
š‘
;

173 
š‘_Ën
 = (
š‘
), 
nsock
;

176 iàĞ(
nsock
 = 
	`acû±
(
sock
, (
sockaddr
 *)&
š‘
, &
š‘_Ën
)) == 0 )

179 
msg
[128];

180 
	`¥rštf
Ğ
msg
, "failed server socket‡ccept [%.64s]\n",

181 
	`¡»¼Ü
(
”ºo
) );

182 
	`”rÜMes§ge
Ğ
msg
 );

183 
	`ex™
( -1 );

187 Ğ
nsock
 );

188 
	}
}

202 
	$»cv_d©a
Ğ
sock
, *
blk
, 
sz
, 
mšsz
 )

205 
rb
 = 0, 
»t
;

209 iàĞ(
»t
=
	`»cv
(
sock
, &
blk
[
rb
], 
sz
-rb, 0)) == -1 )

212 
msg
[128];

213 
	`¥rštf
Ğ
msg
, "failed„eadƒrror [%.64s]\n",

214 
	`¡»¼Ü
(
”ºo
) );

215 
	`”rÜMes§ge
Ğ
msg
 );

216 
	`ex™
( -1 );

220 
rb
 +ğ
»t
;

222  
rb
 < 
mšsz
 );

227 
	}
}

240 
	$£nd_d©a
Ğ
sock
, *
blk
, 
Ën
 )

243 iàĞ
	`£nd
(
sock
, 
blk
, 
Ën
, 0) !=†en )

246 
	`”rÜMes§ge
( "failed socket send [short send]\n" );

247 
	`ex™
( -1 );

253 
	}
}

	@siis-network.h

34 
	#PROTOCOL_PORT
 9165

	)

36 #ià
defšed
(
sun
)

37 
	#INADDR_NONE
 ((
š_addr_t
è0xffffffff)

	)

50 
cÚÃù_ş›Á
Ğ*
addr
 );

60 
£rv”_cÚÃù
( );

70 
£rv”_acû±
Ğ
sock
 );

83 
»cv_d©a
Ğ
sock
, *
blk
, 
sz
, 
mšsz
 );

95 
£nd_d©a
Ğ
sock
, *
blk
, 
Ën
 );

	@siis-ssl.c

33 
	~<¡dio.h
>

34 
	~<¡dlib.h
>

35 
	~<¡ršg.h
>

36 
	~<İ’s¦/cÚf.h
>

37 
	~<İ’s¦/evp.h
>

38 
	~<İ’s¦/r§.h
>

39 
	~<İ’s¦/”r.h
>

40 
	~<İ’s¦/hmac.h
>

41 
	~<sys/ty³s.h
>

42 
	~<as£¹.h
>

43 
	~<uni¡d.h
>

45 
	~"siis-s¦.h
"

48 
	$’üy±
(*
¶aš‹xt
, 
¶aš‹xt_Ën
, *
¯d
,

49 
¯d_Ën
, *
key
, *
iv
,

50 *
ch”‹xt
, *
g
)

52 
EVP_CIPHER_CTX
 *
ùx
;

53 
Ën
;

54 
ch”‹xt_Ën
;

58 if(!(
ùx
 = 
	`EVP_CIPHER_CTX_Ãw
())è
	`hªdËE¼Üs
();

61 if(1 !ğ
	`EVP_Enüy±In™_ex
(
ùx
, 
	`EVP_«s_256_gcm
(), 
NULL
, NULL, NULL))

62 
	`hªdËE¼Üs
();

65 if(1 !ğ
	`EVP_CIPHER_CTX_ù¾
(
ùx
, 
EVP_CTRL_GCM_SET_IVLEN
, 16, 
NULL
))

66 
	`hªdËE¼Üs
();

69 if(1 !ğ
	`EVP_Enüy±In™_ex
(
ùx
, 
NULL
, NULL, 
key
, 
iv
)è
	`hªdËE¼Üs
();

82 if(1 !ğ
	`EVP_Enüy±Upd©e
(
ùx
, 
ch”‹xt
, &
Ën
, 
¶aš‹xt
, 
¶aš‹xt_Ën
))

83 
	`hªdËE¼Üs
();

84 
ch”‹xt_Ën
 = 
Ën
;

89 if(1 !ğ
	`EVP_Enüy±Fš®_ex
(
ùx
, 
ch”‹xt
 + 
Ën
, &Ën)è
	`hªdËE¼Üs
();

90 
ch”‹xt_Ën
 +ğ
Ën
;

93 if(1 !ğ
	`EVP_CIPHER_CTX_ù¾
(
ùx
, 
EVP_CTRL_GCM_GET_TAG
, 16, 
g
))

94 
	`hªdËE¼Üs
();

97 
	`EVP_CIPHER_CTX_ä“
(
ùx
);

99  
ch”‹xt_Ën
;

100 
	}
}

103 
	$deüy±
(*
ch”‹xt
, 
ch”‹xt_Ën
, *
¯d
,

104 
¯d_Ën
, *
g
, *
key
, *
iv
,

105 *
¶aš‹xt
)

107 
EVP_CIPHER_CTX
 *
ùx
;

108 
Ën
;

109 
¶aš‹xt_Ën
;

110 
»t
;

113 if(!(
ùx
 = 
	`EVP_CIPHER_CTX_Ãw
())è
	`hªdËE¼Üs
();

116 if(!
	`EVP_Deüy±In™_ex
(
ùx
, 
	`EVP_«s_256_gcm
(), 
NULL
, NULL, NULL))

117 
	`hªdËE¼Üs
();

120 if(!
	`EVP_CIPHER_CTX_ù¾
(
ùx
, 
EVP_CTRL_GCM_SET_IVLEN
, 16, 
NULL
))

121 
	`hªdËE¼Üs
();

124 if(!
	`EVP_Deüy±In™_ex
(
ùx
, 
NULL
, NULL, 
key
, 
iv
)è
	`hªdËE¼Üs
();

137 if(!
	`EVP_Deüy±Upd©e
(
ùx
, 
¶aš‹xt
, &
Ën
, 
ch”‹xt
, 
ch”‹xt_Ën
))

138 
	`hªdËE¼Üs
();

139 
¶aš‹xt_Ën
 = 
Ën
;

142 if(!
	`EVP_CIPHER_CTX_ù¾
(
ùx
, 
EVP_CTRL_GCM_SET_TAG
, 16, 
g
))

143 
	`hªdËE¼Üs
();

148 
»t
 = 
	`EVP_Deüy±Fš®_ex
(
ùx
, 
¶aš‹xt
 + 
Ën
, &len);

151 
	`EVP_CIPHER_CTX_ä“
(
ùx
);

153 if(
»t
 > 0)

156 
¶aš‹xt_Ën
 +ğ
Ën
;

157  
¶aš‹xt_Ën
;

164 
	}
}

168 
	$dige¡_mes§ge
(cÚ¡ *
mes§ge
, 
size_t
 
mes§ge_Ën
, **
dige¡
, *
dige¡_Ën
)

170 
EVP_MD_CTX
 *
mdùx
;

172 if((
mdùx
 = 
	`EVP_MD_CTX_ü—‹
()è=ğ
NULL
)

173 
	`hªdËE¼Üs
();

175 if(1 !ğ
	`EVP_Dige¡In™_ex
(
mdùx
, 
	`EVP_sha256
(), 
NULL
))

176 
	`hªdËE¼Üs
();

178 if(1 !ğ
	`EVP_Dige¡Upd©e
(
mdùx
, 
mes§ge
, 
mes§ge_Ën
))

179 
	`hªdËE¼Üs
();

181 if((*
dige¡
 = (*)
	`OPENSSL_m®loc
(
	`EVP_MD_size
(
	`EVP_sha256
()))è=ğ
NULL
)

182 
	`hªdËE¼Üs
();

184 if(1 !ğ
	`EVP_Dige¡Fš®_ex
(
mdùx
, *
dige¡
, 
dige¡_Ën
))

185 
	`hªdËE¼Üs
();

187 
	`EVP_MD_CTX_de¡roy
(
mdùx
);

188 
	}
}

192 
	$hmac_mes§ge
(* 
msg
, 
size_t
 
mËn
, ** 
v®
, size_t* 
vËn
, *
key
)

194 
HMAC_CTX
 
ùx
;

195 cÚ¡ 
EVP_MD
* 
md
 = 
NULL
;

197 
	`O³nSSL_add_®l_dige¡s
();

199 
md
 = 
	`EVP_g‘_dige¡byÇme
("SHA256");

200 
	`HMAC_CTX_š™
Ğ&
ùx
 );

202 if(!
	`HMAC_In™_ex
(&
ùx
, 
key
, (key), 
md
, 
NULL
))

203 
	`hªdËE¼Üs
();

205 if(!
	`HMAC_Upd©e
(&
ùx
, 
msg
, 
mËn
))

206 
	`hªdËE¼Üs
();

208 if(!
	`HMAC_Fš®
(&
ùx
, *
v®
, (*)
vËn
))

209 
	`hªdËE¼Üs
();

211 
	`HMAC_CTX_ş—nup
(&
ùx
);

214 
i
;

216 
	`´štf
("HMAC is: ");

217 
i
 = 0; i < *
vËn
; i++)

218 
	`´štf
("%02x", (*
v®
)[
i
]);

219 
	`´štf
("\n");

223 
	}
}

226 
	$r§_’üy±
(*
msg
, 
msgL’
, **
’cMsg
, **
ek
,

227 *
ekl
, **
iv
, *
ivl
, 
EVP_PKEY
 *
pubkey
)

229 
’cMsgL’
 = 0;

230 
blockL’
 = 0;

231 
EVP_CIPHER_CTX
 *
r§Enüy±Ctx
;

233 *
ivl
 = 
EVP_MAX_IV_LENGTH
;

234 *
ekl
 = 
	`EVP_PKEY_size
(
pubkey
);

235 *
ek
 = (*)
	`m®loc
(*
ekl
);

236 *
iv
 = (*)
	`m®loc
(*
ivl
);

237 if(*
ek
 =ğ
NULL
 || *
iv
 == NULL)  -1;

238 
	`mem£t
Ğ*
iv
, 0, *
ivl
 );

240 *
’cMsg
 = (*)
	`m®loc
(
msgL’
 + *
ivl
);

241 if(
’cMsg
 =ğ
NULL
)  -1;

243 if(!(
r§Enüy±Ctx
 = 
	`EVP_CIPHER_CTX_Ãw
())è
	`hªdËE¼Üs
();

245 if(!
	`EVP_S—lIn™
(
r§Enüy±Ctx
, 
	`EVP_«s_256_cbc
(), 
ek
, (*)
ekl
, *
iv
, &
pubkey
, 1)) {

246 
	`hªdËE¼Üs
();

249 if(!
	`EVP_S—lUpd©e
(
r§Enüy±Ctx
, *
’cMsg
 + 
’cMsgL’
, (*)&
blockL’
, 
msg
, 
msgL’
)) {

250 
	`hªdËE¼Üs
();

252 
’cMsgL’
 +ğ
blockL’
;

254 if(!
	`EVP_S—lFš®
(
r§Enüy±Ctx
, *
’cMsg
 + 
’cMsgL’
, (*)&
blockL’
)) {

255 
	`hªdËE¼Üs
();

257 
’cMsgL’
 +ğ
blockL’
;

259 
	`EVP_CIPHER_CTX_ş—nup
(
r§Enüy±Ctx
);

261  ()
’cMsgL’
;

262 
	}
}

265 
	$r§_deüy±
(*
’cMsg
, 
’cMsgL’
, *
ek
, 
ekl
,

266 *
iv
, 
ivl
, **
decMsg
, 
EVP_PKEY
 *
´ivkey
)

268 
decL’
 = 0;

269 
blockL’
 = 0;

270 
EVP_CIPHER_CTX
 *
r§Deüy±Ctx
;

272 *
decMsg
 = (*)
	`m®loc
(
’cMsgL’
 + 
ivl
);

273 if(
decMsg
 =ğ
NULL
)  -1;

275 if(!(
r§Deüy±Ctx
 = 
	`EVP_CIPHER_CTX_Ãw
())è
	`hªdËE¼Üs
();

277 if(!
	`EVP_O³nIn™
(
r§Deüy±Ctx
, 
	`EVP_«s_256_cbc
(), 
ek
, 
ekl
, 
iv
, 
´ivkey
)) {

278 
	`hªdËE¼Üs
();

281 if(!
	`EVP_O³nUpd©e
(
r§Deüy±Ctx
, (*)*
decMsg
 + 
decL’
, (*)&
blockL’
, 
’cMsg
, ()
’cMsgL’
)) {

282 
	`hªdËE¼Üs
();

284 
decL’
 +ğ
blockL’
;

286 if(!
	`EVP_O³nFš®
(
r§Deüy±Ctx
, (*)*
decMsg
 + 
decL’
, (*)&
blockL’
)) {

287 
	`hªdËE¼Üs
();

289 
decL’
 +ğ
blockL’
;

291 
	`EVP_CIPHER_CTX_ş—nup
(
r§Deüy±Ctx
);

293  ()
decL’
;

294 
	}
}

298 
	$hªdËE¼Üs
()

300 
	`ERR_´št_”rÜs_å
(
¡d”r
);

301 
	`abÜt
();

302 
	}
}

	@siis-ssl.h

35 
’üy±
(*
¶aš‹xt
, 
¶aš‹xt_Ën
, *
¯d
,

36 
¯d_Ën
, *
key
, *
iv
,

37 *
ch”‹xt
, *
g
);

38 
deüy±
(*
ch”‹xt
, 
ch”‹xt_Ën
, *
¯d
,

39 
¯d_Ën
, *
g
, *
key
, *
iv
,

40 *
¶aš‹xt
);

41 
dige¡_mes§ge
(cÚ¡ *
mes§ge
, 
size_t
 
mes§ge_Ën
,

42 **
dige¡
, *
dige¡_Ën
);

43 
hmac_mes§ge
(* 
msg
, 
size_t
 
mËn
, ** 
v®
, size_t* 
vËn
,

44 *
key
);

45 
r§_’üy±
(*
msg
, 
msgL’
, **
’cMsg
, **
ek
,

46 *
ekl
, **
iv
, *
ivl
, 
EVP_PKEY
 *
pubkey
);

47 
r§_deüy±
(*
’cMsg
, 
’cMsgL’
, *
ek
, 
ekl
,

48 *
iv
, 
ivl
, **
decMsg
, 
EVP_PKEY
 *
´ivkey
);

49 
ENGINE
 *
’gše_š™
( );

50 
’gše_ş—nup
Ğ
ENGINE
 *
’g
 );

51 
üy±o_š™
( );

52 
üy±o_ş—nup
( );

53 
hªdËE¼Üs
();

	@siis-util.c

33 
	~<¡dio.h
>

34 
	~<¡ršgs.h
>

35 
	~<¡dlib.h
>

36 
	~<as£¹.h
>

37 
	~<sys/ty³s.h
>

38 
	~<sys/¡©.h
>

39 
	~<uni¡d.h
>

41 
	~"siis-ut.h
"

54 
	$”rÜMes§ge
Ğ*
msg
 )

57 
	`årštf
Ğ
¡d”r
, "E¼Ü: %s\n", 
msg
 );

59 
	}
}

70 
	$w¬nšgMes§ge
Ğ*
msg
 )

73 
	`årštf
Ğ
¡d”r
, "W¬nšg: %s\n", 
msg
 );

75 
	}
}

89 
	$´štBufãr
Ğ*
msg
, *
buf
, 
Ën
 )

92 
i
;

93 iàĞ
msg
 !ğ
NULL
 ) 
	`´štf
( "%s : ", msg );

94 iàĞ
buf
 !ğ
NULL
 )

96  
i
=0; i<
Ën
; i++ )

98 
	`´štf
Ğ"%2X ", ()
buf
[
i
] );

103 
	`´štf
( "(null)" );

105 
	`´štf
( "\n" );

107 
	}
}

121 
	$bufãr_äom_fe
(*
f•©h
, **
buf
)

123 
”r
;

124 
¡©
 *
¡©buf
;

125 
FILE
 *
åŒ
;

126 
size_t
 
fesize
;

128 
¡©buf
 = (
¡©
 *)
	`m®loc
((stat));

129 
	`as£¹
Ğ
¡©buf
 !ğ
NULL
 );

131 
”r
 = 
	`¡©
Ğ
f•©h
, 
¡©buf
 );

134 iàĞ
”r
 != 0 ) {

135 
fesize
 = 0;

138 ià(!Ğ
fesize
 = 
¡©buf
->
¡_size
 ));

142 
	`as£¹
Ğ
fesize
 > 0 );

145 *
buf
 = (*)
	`m®loc
(
fesize
);

146 
	`as£¹
Ğ*
buf
 !ğ
NULL
 );

148 
åŒ
 = 
	`fİ’
Ğ
f•©h
, "r" );

149 iàĞ
åŒ
 !ğ
NULL
 ) {

150 
”r
 = 
	`ä—d
Ğ*
buf
, 1, 
fesize
, 
åŒ
 );

151 
	`as£¹
Ğ
”r
 =ğ
fesize
 );

153 
	`fşo£
Ğ
åŒ
 );

156 
	`ä“
Ğ
¡©buf
 );

158  
fesize
;

159 
	}
}

	@siis-util.h

45 
”rÜMes§ge
Ğ*
msg
 );

55 
w¬nšgMes§ge
Ğ*
msg
 );

67 
´štBufãr
Ğ*
msg
, *
buf
, 
Ën
 );

78 
bufãr_äom_fe
(*
f•©h
, **
buf
);

	@transfer.c

35 
	~<¡dio.h
>

36 
	~<fú.h
>

37 
	~<¡dlib.h
>

38 
	~<”ºo.h
>

39 
	~<as£¹.h
>

40 
	~<uni¡d.h
>

41 
	~<¡ršg.h
>

42 
	~<sys/£Ëù.h
>

43 
	~<sys/ty³s.h
>

44 
	~<Ãtš‘/š.h
>

45 
	~<š‰y³s.h
>

48 
	~<İ’s¦/cÚf.h
>

49 
	~<İ’s¦/evp.h
>

50 
	~<İ’s¦/³m.h
>

51 
	~<İ’s¦/¿nd.h
>

52 
	~<İ’s¦/”r.h
>

53 
	~<İ’s¦/bn.h
>

54 
	~<İ’s¦/r§.h
>

57 
	~"siis-ut.h
"

58 
	~"siis-ÃtwÜk.h
"

59 
	~"siis-s¦.h
"

60 
	~"Œªsãr.h
"

77 
	$make_»q_¡ruù
Ğ
rm_cmd
 **
½Œ
, *
f’ame
, *
cmd
, *
ty³
 )

79 
rm_cmd
 *
r
;

80 
rsize
;

81 
Ën
;

83 
	`as£¹
(
½Œ
 != 0);

84 
	`as£¹
(
f’ame
 != 0);

85 
Ën
 = 
	`¡¾’
Ğ
f’ame
 );

87 
rsize
 = (
rm_cmd
è+ 
Ën
;

88 *
½Œ
 = 
r
 = (
rm_cmd
 *è
	`m®loc
Ğ
rsize
 );

89 
	`mem£t
Ğ
r
, 0, 
rsize
 );

91 
r
->
Ën
 =†en;

92 
	`memıy
Ğ
r
->
âame
, 
f’ame
,„->
Ën
 );

93 
r
->
cmd
 = 
	`©oi
( cmd );

94 
r
->
ty³
 = 
	`©oi
(ype );

97 
	}
}

111 
	$g‘_mes§ge
Ğ
sock
, 
PrÙoMes§geHdr
 *
hdr
, *
block
 )

114 
	`»cv_d©a
Ğ
sock
, (*)
hdr
, (
PrÙoMes§geHdr
),

115 (
PrÙoMes§geHdr
) );

116 
hdr
->
Ëngth
 = 
	`Áohs
(hdr->length);

117 
	`as£¹
Ğ
hdr
->
Ëngth
<
MAX_BLOCK_SIZE
 );

118 
hdr
->
msgty³
 = 
	`Áohs
( hdr->msgtype );

119 iàĞ
hdr
->
Ëngth
 > 0 )

120 Ğ
	`»cv_d©a
Ğ
sock
, 
block
, 
hdr
->
Ëngth
, hdr->length ) );

122 
	}
}

136 
	$wa™_mes§ge
Ğ
sock
, 
PrÙoMes§geHdr
 *
hdr
,

137 *
block
, 
PrÙoMes§geTy³
 
mt
 )

140 
»t
 = 
	`g‘_mes§ge
Ğ
sock
, 
hdr
, 
block
 );

141 iàĞ
hdr
->
msgty³
 !ğ
mt
 )

144 
msg
[128];

145 
	`¥rštf
Ğ
msg
, "Server unableo…rocess messageype [%d != %d]\n",

146 
hdr
->
msgty³
, 
mt
 );

147 
	`”rÜMes§ge
Ğ
msg
 );

148 
	`ex™
( -1 );

152 Ğ
»t
 );

153 
	}
}

166 
	$£nd_mes§ge
Ğ
sock
, 
PrÙoMes§geHdr
 *
hdr
, *
block
 )

168 
»®_Ën
 = 0;

171 
»®_Ën
 = 
hdr
->
Ëngth
;

172 
hdr
->
msgty³
 = 
	`htÚs
( hdr->msgtype );

173 
hdr
->
Ëngth
 = 
	`htÚs
( hdr->length );

174 iàĞ
block
 =ğ
NULL
 )

175 Ğ
	`£nd_d©a
Ğ
sock
, (*)
hdr
, (hdr) ) );

177 Ğ
	`£nd_d©a
(
sock
, (*)
hdr
, (hdr)) ||

178 
	`£nd_d©a
(
sock
, 
block
, 
»®_Ën
) );

179 
	}
}

196 
	$’üy±_mes§ge
Ğ*
¶aš‹xt
, 
¶aš‹xt_Ën
, *
key
,

197 *
bufãr
, *
Ën
 )

206 
	}
}

224 
	$deüy±_mes§ge
Ğ*
bufãr
, 
Ën
, *
key
,

225 *
¶aš‹xt
, *
¶aš‹xt_Ën
 )

230 
	}
}

242 
	$g’”©e_p£udÜªdom_by‹s
(*
bufãr
, 
size
)

247 
	}
}

261 
	$§ve_key
(cÚ¡ *
âame
, *
key
, 
keysize
) {

264 
	}
}

278 
	$lßd_key
(cÚ¡ *
âame
, *
key
, 
keysize
) {

281 
	}
}

304 
	$Œªsãr_fe
Ğ
rm_cmd
 *
r
, *
âame
, 
sock
,

305 *
key
 )

308 
»adBy‹s
 = 1, 
tÙ®By‹s
 = 0, 
fh
;

309 
PrÙoMes§geHdr
 
hdr
;

310 
block
[
MAX_BLOCK_SIZE
];

313 iàĞ(
fh
=
	`İ’
(
âame
, 
O_RDONLY
, 0)) == -1 )

316 
msg
[128];

317 
	`¥rštf
Ğ
msg
, "çu» o³nšg f[%.64s]\n", 
âame
 );

318 
	`”rÜMes§ge
Ğ
msg
 );

319 
	`ex™
( -1 );

323 
hdr
.
msgty³
 = 
FILE_XFER_INIT
;

324 
hdr
.
Ëngth
 = (
rm_cmd
è+ 
r
->
Ën
;

325 
	`£nd_mes§ge
Ğ
sock
, &
hdr
, (*)
r
 );

328  (
r
->
cmd
 =ğ
CMD_CREATE
è&& (
»adBy‹s
 != 0) )

331 iàĞ(
»adBy‹s
=
	`»ad
Ğ
fh
, 
block
, 
BLOCKSIZE
 )) == -1 )

334 
	`”rÜMes§ge
( "failed„ead on data file.\n" );

335 
	`ex™
( -1 );

339 
tÙ®By‹s
 +ğ
»adBy‹s
;

340 
	`´štf
Ğ"R—dšg %10d by‹ ...\n", 
tÙ®By‹s
 );

343 iàĞ
»adBy‹s
 > 0 )

345 #ifdeà
DEBUG


346 
	`´štf
("Block is:\n");

347 
	`BIO_dump_å
 (
¡dout
, (cÚ¡ *)
block
, 
»adBy‹s
);

357 
hdr
.
msgty³
 = 
EXIT
;

358 
hdr
.
Ëngth
 = 0;

359 
	`£nd_mes§ge
Ğ
sock
, &
hdr
, 
NULL
 );

360 
	`wa™_mes§ge
Ğ
sock
, &
hdr
, 
block
, 
EXIT
 );

363 
	`şo£
Ğ
fh
 );

365 
	}
}

379 
	$ş›Á_£cu»_Œªsãr
Ğ
rm_cmd
 *
r
, *
âame
, *
add»ss
 )

382 
key
[
KEYSIZE
];

383 
sock
;

386 
	`lßd_key
("./’ckey", 
key
, 
KEYSIZE
);

388 
sock
 = 
	`cÚÃù_ş›Á
Ğ
add»ss
 );

390 
	`Œªsãr_fe
Ğ
r
, 
âame
, 
sock
, 
key
 );

392 
	`şo£
Ğ
sock
 );

396 
	}
}

413 
	$‹¡_«s
( )

415 
rc
 = 0;

416 *
key
;

417 *
ch”‹xt
, *
g
;

418 *
¶aš‹xt
;

419 *
iv
 = (*)"0123456789012345";

420 
ş’
 = 0, 
¶’
 = 0;

421 
msg
[] = "Help me, Mr. Wizard!";

422 
¶aš‹xt_Ën
 = 
	`¡¾’
(
msg
);

424 
	`´štf
("*** Test AESƒncrypt‡nd decrypt. ***\n");

427 
key
ğ(*)
	`m®loc
Ğ
KEYSIZE
 );

429 
	`memıy
Ğ
key
, "ABCDEFGH_IJKLMNOabcdefgh_ijklmno", 
KEYSIZE
 );

430 
	`as£¹
Ğ
rc
 == 0 );

433 
ch”‹xt
 = (*)
	`m®loc
Ğ
¶aš‹xt_Ën
 );

434 
g
 = (*)
	`m®loc
Ğ
TAGSIZE
 );

435 
ş’
 = 
	`’üy±
Ğ(*è
msg
, 
¶aš‹xt_Ën
, (*)
NULL
, 0, 
key
, 
iv
, 
ch”‹xt
, 
g
);

436 
	`as£¹
(Ğ
ş’
 > 0 ) && ( cËÀ<ğ
¶aš‹xt_Ën
 ));

438 
	`´štf
("Ciphertext is:\n");

439 
	`BIO_dump_å
 (
¡dout
, (cÚ¡ *)
ch”‹xt
, 
ş’
);

441 
	`´štf
("Tag is:\n");

442 
	`BIO_dump_å
 (
¡dout
, (cÚ¡ *)
g
, 
TAGSIZE
);

445 
¶aš‹xt
 = (*)
	`m®loc
Ğ
ş’
+
TAGSIZE
 );

446 
	`mem£t
Ğ
¶aš‹xt
, 0, 
ş’
+
TAGSIZE
 );

447 
¶’
 = 
	`deüy±
Ğ
ch”‹xt
, 
ş’
, (*è
NULL
, 0,

448 
g
, 
key
, 
iv
, 
¶aš‹xt
 );

449 
	`as£¹
Ğ
¶’
 > 0 );

453 
	`´štf
("Decryptedext is: \n");

454 
	`BIO_dump_å
 (
¡dout
, (cÚ¡ *)
¶aš‹xt
, ()
¶’
);

457 
	`´štf
("Msg: %s\n", 
¶aš‹xt
 );

460 
	}
}

472 
	#FILE_PREFIX
 "./sh¬ed/"

	)

474 
	$»ûive_fe
Ğ
sock
, *
key
 )

477 
tÙ®By‹s
 = 0;

478 
dÚe
 = 0, 
fh
 = 0;

479 
outby‹s
;

480 
PrÙoMes§geHdr
 
hdr
;

481 
rm_cmd
 *
r
 = 
NULL
;

482 
block
[
MAX_BLOCK_SIZE
];

483 
¶aš‹xt
[
MAX_BLOCK_SIZE
+
TAGSIZE
];

484 *
âame
 = 
NULL
;

485 
rc
 = 0;

488 
	`bz”o
(
block
, 
MAX_BLOCK_SIZE
);

491 
	`wa™_mes§ge
Ğ
sock
, &
hdr
, 
block
, 
FILE_XFER_INIT
 );

494 
rm_cmd
 *
tmp
 = (rm_cmd *)
block
;

495 
Ën
 = 
tmp
->len;

496 
r
 = (
rm_cmd
 *)
	`m®loc
Ğ(rm_cmdè+ 
Ën
 );

497 
r
->
cmd
 = 
tmp
->cmd,„->
ty³
 =mp->ty³,„->
Ën
 =†en;

498 
	`memıy
Ğ
r
->
âame
, 
tmp
->âame, 
Ën
 );

501 iàĞ
r
->
ty³
 =ğ
TYP_DATA_SHARED
 ) {

502 
size
 = 
r
->
Ën
 + 
	`¡¾’
(
FILE_PREFIX
) + 1;

503 
âame
 = (*)
	`m®loc
Ğ
size
 );

504 
	`¢´štf
Ğ
âame
, 
size
, "%s%.*s", 
FILE_PREFIX
, (è
r
->
Ën
,„->fname );

505 iàĞ(
fh
=
	`İ’
Ğ
âame
, 
O_WRONLY
|
O_CREAT
, 0700)) > 0 );

506 
	`as£¹
( 0 );

509 
	`as£¹
( 0 );

512 iàĞ
r
->
cmd
 =ğ
CMD_CREATE
 ) {

514 
	`´štf
Ğ"Reûivšg f[%s] ..\n", 
âame
 );

515 !
dÚe
)

518 
	`g‘_mes§ge
Ğ
sock
, &
hdr
, 
block
 );

519 iàĞ
hdr
.
msgty³
 =ğ
EXIT
 ) {

520 
dÚe
 = 1;

525 #ià
DEBUG


526 
	`´štf
("Reûived Block (%u by‹sèis:\n", 
hdr
.
Ëngth
);

527 
	`BIO_dump_å
 (
¡dout
, (cÚ¡ *)
block
, 
hdr
.
Ëngth
);

531 
rc
 = 
	`deüy±_mes§ge
Ğ(*)
block
, 
hdr
.
Ëngth
, 
key
,

532 
¶aš‹xt
, &
outby‹s
 );

533 
	`as£¹
Ğ
rc
 == 0 );

534 
	`wr™e
Ğ
fh
, 
¶aš‹xt
, 
outby‹s
 );

536 #ià
DEBUG


537 
	`´štf
("Decrypted Block is:\n");

538 
	`BIO_dump_å
 (
¡dout
, (cÚ¡ *)
¶aš‹xt
, 
outby‹s
);

541 
tÙ®By‹s
 +ğ
outby‹s
;

542 
	`´štf
Ğ"Reûived/wr™‹À%ld by‹ ...\n", 
tÙ®By‹s
 );

545 
	`´štf
Ğ"TÙ® by‹ [%ld].\n", 
tÙ®By‹s
 );

547 
	`şo£
Ğ
fh
 );

550 
	`´štf
Ğ"S”v”: iÎeg® commªd %d\n", 
r
->
cmd
 );

555 
hdr
.
msgty³
 = 
EXIT
;

556 
hdr
.
Ëngth
 = 0;

557 
	`£nd_mes§ge
Ğ
sock
, &
hdr
, 
NULL
 );

560 
	}
}

571 
	$£rv”_£cu»_Œªsãr
(*
key
)

574 
£rv”
, 
”rÜed
, 
Ãwsock
;

575 
fd_£t
 
»adfds
;

578 
	`O³nSSL_add_®l_®gÜ™hms
();

579 
	`O³nSSL_add_®l_ch”s
();

580 
	`ERR_lßd_üy±o_¡ršgs
();

583 #ifdeà
DEBUG


584 
	`‹¡_«s
();

588 
£rv”
 = 
	`£rv”_cÚÃù
();

589 
”rÜed
 = 0;

592 
	`lßd_key
("./’ckey", 
key
, 
KEYSIZE
);

595  !
”rÜed
 )

597 
	`FD_ZERO
Ğ&
»adfds
 );

598 
	`FD_SET
Ğ
£rv”
, &
»adfds
 );

599 iàĞ
	`£Ëù
(
£rv”
+1, &
»adfds
, 
NULL
, NULL, NULL) < 1 )

602 
msg
[128];

603 
	`¥rštf
Ğ
msg
, "failure selecting server connection [%.64s]\n",

604 
	`¡»¼Ü
(
”ºo
) );

605 
	`”rÜMes§ge
Ğ
msg
 );

606 
”rÜed
 = 1;

611 iàĞ(
Ãwsock
 = 
	`£rv”_acû±
(
£rv”
)) != -1 )

614 
	`»ûive_fe
Ğ
Ãwsock
, 
key
 );

615 
	`şo£
Ğ
Ãwsock
 );

620 
msg
[128];

621 
	`¥rštf
Ğ
msg
, "failure‡ccepting connection [%.64s]\n",

622 
	`¡»¼Ü
(
”ºo
) );

623 
	`”rÜMes§ge
Ğ
msg
 );

624 
”rÜed
 = 1;

631 
	}
}

	@transfer.h

37 
	#MAX_BLOCK_SIZE
 8096

	)

38 
	#BLOCKSIZE
 128

	)

39 
	#KEYSIZE
 32

	)

40 
	#TAGSIZE
 16

	)

41 
	#IVSIZE
 16

	)

43 
	#PUBKEY_FILE
 "./pubkey.tmp"

	)

46 
	#CMD_CREATE
 1

	)

47 
	#TYP_DATA_SHARED
 1

	)

53 
	mCLIENT_INIT_EXCHANGE
,

54 
	mSERVER_INIT_RESPONSE
,

55 
	mCLIENT_INIT_ACK
,

56 
	mSERVER_INIT_ACK
,

57 
	mFILE_XFER_INIT
,

58 
	mFILE_XFER_BLOCK
,

59 
	mEXIT
,

60 } 
	tPrÙoMes§geTy³
;

64 
	mmsgty³
;

65 
	mËngth
;

66 } 
	tPrÙoMes§geHdr
;

69 
	srm_cmd
 {

70 
	mcmd
;

71 
	mty³
;

72 
	mËn
;

73 
	mâame
[0];

89 
ş›Á_£cu»_Œªsãr
Ğ
rm_cmd
 *
r
, *
âame
, *
add»ss
 );

99 
£rv”_£cu»_Œªsãr
(*
key
);

112 
make_»q_¡ruù
Ğ
rm_cmd
 **
½Œ
, *
f’ame
, *
cmd
, *
ty³
 );

123 
g’”©e_p£udÜªdom_by‹s
(*
bufãr
, 
size
);

137 
§ve_key
(cÚ¡ *
âame
, *
key
, 
keysize
);

	@
1
.
0
9
105
main.c
siis-network.c
siis-network.h
siis-ssl.c
siis-ssl.h
siis-util.c
siis-util.h
transfer.c
transfer.h
